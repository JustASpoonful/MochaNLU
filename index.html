<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MochaLLM Studio v5.3: Toolbox Edition</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap');

        :root {
            --bg-main: #09090b;
            --bg-panel: #18181b; 
            --accent: #3b82f6; /* Blue 500 */
            --accent-dim: #2563eb;
            --accent-glow: rgba(59, 130, 246, 0.15);
            --text-main: #fafafa;
            --border: #27272a;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3f3f46; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #52525b; }

        .panel {
            background: var(--bg-panel);
            border: 1px solid var(--border);
        }

        .input-field {
            background: #09090b;
            border: 1px solid var(--border);
            transition: all 0.2s ease;
        }
        .input-field:focus {
            border-color: var(--accent);
            outline: none;
            box-shadow: 0 0 0 2px var(--accent-glow);
        }

        .mono-text { font-family: 'JetBrains Mono', monospace; }

        /* Chat Bubbles */
        .bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 0.95rem;
            line-height: 1.6;
            animation: fadeIn 0.3s ease-out;
            position: relative;
        }
        
        .bubble-user {
            background-color: #27272a;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 2px;
        }
        
        .bubble-ai {
            background: linear-gradient(135deg, #1e3a8a, #172554);
            color: #dbeafe;
            align-self: flex-start;
            border-bottom-left-radius: 2px;
            border: 1px solid #1e40af;
        }

        .bubble-system {
            background: transparent;
            border: 1px dashed #3f3f46;
            color: #71717a;
            font-size: 0.8rem;
            align-self: center;
            width: 100%;
            text-align: center;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .typing-dot {
            display: inline-block;
            width: 5px;
            height: 5px;
            background: #60a5fa;
            border-radius: 50%;
            margin-right: 2px;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        #training-overlay, #import-overlay { backdrop-filter: blur(8px); background: rgba(9, 9, 11, 0.9); }

        /* Token Visualization */
        .token-chip {
            display: inline-block;
            padding: 2px 5px;
            margin: 1px;
            border-radius: 4px;
            font-size: 10px;
            font-family: 'JetBrains Mono', monospace;
            background: #27272a;
            border: 1px solid #3f3f46;
            color: #d4d4d8;
        }
        .token-chip.match { border-color: #3b82f6; color: #93c5fd; background: rgba(59, 130, 246, 0.1); }
        .token-chip.gen { border-color: #a855f7; color: #e9d5ff; }

        /* Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 14px; width: 14px; border-radius: 50%;
            background: var(--accent); cursor: pointer; margin-top: -5px; 
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%; height: 4px; cursor: pointer; background: #3f3f46; border-radius: 2px;
        }

        .btn-primary {
            background: var(--accent); color: white; transition: all 0.2s;
        }
        .btn-primary:hover { filter: brightness(1.1); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0px); }

        .btn-secondary {
            background: #27272a; color: #a1a1aa; transition: all 0.2s;
        }
        .btn-secondary:hover { background: #3f3f46; color: white; }
        
        .badge {
            font-size: 9px; padding: 2px 6px; border-radius: 4px; font-weight: bold; text-transform: uppercase;
        }
        .badge-vec { background: #172554; color: #60a5fa; border: 1px solid #1e40af; }
        .badge-gen { background: #3b0764; color: #c084fc; border: 1px solid #6b21a8; }
        .badge-fail { background: #450a0a; color: #fca5a5; border: 1px solid #7f1d1d; }
        .badge-tool { background: #ca8a04; color: #fef08a; border: 1px solid #a16207; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden selection:bg-blue-500/30">

    <!-- Header -->
    <header class="panel h-14 px-4 flex justify-between items-center z-20 border-b-0 border-[#27272a]">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-br from-blue-600 to-indigo-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-blue-900/20">
                <i class="fa-solid fa-toolbox"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold tracking-wide">MochaLLM <span class="text-blue-400">v5.3</span></h1>
                <p class="text-[10px] text-zinc-500 font-mono">Toolbox Edition</p>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <button id="copy-btn" class="btn-secondary px-3 py-1.5 rounded-md text-[10px] font-medium flex items-center gap-2 border border-[#3f3f46]">
                <i class="fa-regular fa-copy"></i> Copy
            </button>

            <div class="h-6 w-px bg-zinc-800 mx-1"></div>

             <div class="flex flex-col items-end">
                <div class="flex justify-between w-24 mb-1">
                    <span class="text-[9px] text-zinc-400 uppercase font-bold">Temperature</span>
                    <span id="temp-val" class="text-[9px] text-blue-400 font-mono">0.5</span>
                </div>
                <input type="range" id="temperature" min="0.1" max="1.2" step="0.1" value="0.5" class="w-24">
            </div>

            <div class="h-6 w-px bg-zinc-800 mx-1"></div>
            
            <button id="reset-btn" class="text-xs text-zinc-500 hover:text-red-400 transition-colors flex items-center gap-1" title="Reset Data">
                <i class="fa-solid fa-power-off"></i>
            </button>
        </div>
    </header>

    <main class="flex-1 flex overflow-hidden relative">
        
        <!-- Left Panel: Training Configuration -->
        <section class="w-[450px] panel border-r border-[#27272a] flex flex-col z-10 flex-shrink-0">
            
            <div class="p-4 border-b border-[#27272a] bg-[#101012]">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-microchip"></i> System Instruction
                    </h2>
                    <span class="text-[9px] text-zinc-600">Base behavior</span>
                </div>
                <textarea id="system-prompt" class="w-full h-12 input-field rounded-md p-2 text-xs text-emerald-100/90 font-sans resize-none placeholder-zinc-700 focus:border-emerald-500/50" placeholder="You are a helpful AI assistant..."></textarea>
            </div>

            <div class="flex-1 flex flex-col bg-[#09090b] min-h-0">
                <div class="px-4 py-2 bg-[#121214] border-b border-[#27272a] flex justify-between items-center">
                    <h2 class="text-[10px] font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-database"></i> Training Dataset
                    </h2>
                    <div class="flex items-center gap-2">
                        <button id="import-btn" class="text-[9px] text-blue-300 hover:text-white bg-blue-900/30 px-2 py-0.5 rounded border border-blue-900 transition-colors">
                            <i class="fa-solid fa-file-import"></i> Import Text
                        </button>
                        <div id="dataset-stats" class="text-[9px] mono-text text-zinc-500 bg-zinc-900 px-2 py-0.5 rounded border border-zinc-800">
                            0 Pairs
                        </div>
                    </div>
                </div>
                
                <div class="flex-1 relative group">
                    <textarea id="training-data" class="w-full h-full bg-transparent text-zinc-300 p-4 text-xs mono-text leading-relaxed resize-none focus:outline-none placeholder-zinc-700" 
                    placeholder="// Add Q&A Pairs. No limit.&#10;&#10;User: Hello&#10;AI: Hi there!&#10;&#10;User: 2+2?&#10;AI: 4" spellcheck="false"></textarea>
                </div>
            </div>

            <div class="p-4 border-t border-[#27272a] bg-[#121214]">
                <div class="grid grid-cols-2 gap-3 mb-4">
                    <div>
                        <label class="block text-[9px] text-zinc-500 uppercase font-bold mb-1">Vector Epochs</label>
                        <input type="number" id="param-epochs" value="100" min="10" max="1000" class="w-full bg-[#09090b] border border-zinc-700 rounded px-2 py-1 text-xs text-white focus:border-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-[9px] text-zinc-500 uppercase font-bold mb-1">Repetition Penalty</label>
                        <select id="param-penalty" class="w-full bg-[#09090b] border border-zinc-700 rounded px-2 py-1 text-xs text-white focus:border-blue-500 outline-none">
                            <option value="1.0">None (1.0)</option>
                            <option value="1.2">Low (1.2)</option>
                            <option value="1.5" selected>High (1.5)</option>
                        </select>
                    </div>
                </div>

                <button id="train-btn" class="w-full btn-primary font-bold py-3 px-4 rounded-lg shadow-lg shadow-blue-900/20 flex justify-center items-center gap-2 text-xs uppercase tracking-wide">
                    <i class="fa-solid fa-bolt"></i> Vectorize & Train
                </button>
            </div>
        </section>

        <!-- Right Panel: Inference/Chat -->
        <section class="flex-1 flex flex-col relative bg-[#09090b]">
            
            <div id="chat-container" class="flex-1 p-6 overflow-y-auto flex flex-col gap-4 scroll-smooth">
                <div id="welcome-msg" class="h-full flex flex-col items-center justify-center text-zinc-600 opacity-40 select-none">
                    <i class="fa-solid fa-toolbox text-4xl mb-4"></i>
                    <p class="text-sm font-medium">System Online</p>
                    <p class="text-xs">Paste data and click "Vectorize & Train"</p>
                </div>
            </div>

            <!-- Inference Viz -->
            <div id="viz-bar" class="h-0 overflow-hidden bg-[#121214] border-t border-[#27272a] transition-all duration-300 flex flex-col">
                <div class="px-4 py-2 border-b border-[#27272a] flex justify-between items-center">
                    <span class="text-[10px] font-bold text-blue-400 uppercase tracking-widest flex items-center gap-2">
                        <i class="fa-solid fa-microscope"></i> Logic Trace
                    </span>
                    <span id="confidence-score" class="text-[9px] mono-text text-zinc-500">Waiting...</span>
                </div>
                <div class="p-2 overflow-x-auto whitespace-nowrap flex items-center gap-2" id="token-viz-container"></div>
            </div>

            <!-- Input -->
            <div class="p-4 bg-[#09090b] border-t border-[#27272a]">
                <form id="chat-form" class="relative">
                    <input type="text" id="user-input" class="w-full input-field text-white rounded-lg pl-4 pr-12 py-3.5 text-sm placeholder-zinc-600 font-light" placeholder="Initializing..." disabled autocomplete="off">
                    <button type="submit" id="send-btn" class="absolute right-2 top-2 bottom-2 w-9 bg-[#27272a] hover:bg-blue-600 text-zinc-400 hover:text-white rounded-md flex items-center justify-center transition-all disabled:opacity-0 disabled:scale-75">
                        <i class="fa-solid fa-paper-plane text-xs"></i>
                    </button>
                </form>
            </div>
        </section>

        <!-- Training Modal -->
        <div id="training-overlay" class="absolute inset-0 z-50 flex items-center justify-center hidden flex-col">
            <div class="bg-[#18181b] border border-[#27272a] p-1 rounded-xl shadow-2xl w-[400px] max-w-[90%]">
                <div class="p-5">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-sm font-bold text-white flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-blue-500 animate-pulse"></span>
                            Building Vector Index
                        </h3>
                        <span id="epoch-counter" class="text-xs font-mono text-zinc-400">0%</span>
                    </div>

                    <div class="h-32 w-full mb-4 bg-[#09090b] rounded-lg border border-[#27272a] relative overflow-hidden">
                        <canvas id="lossChart"></canvas>
                    </div>

                    <div class="w-full bg-[#27272a] h-1.5 rounded-full overflow-hidden mb-2">
                        <div id="train-progress" class="bg-blue-500 h-full w-0 transition-all duration-75"></div>
                    </div>
                </div>
                
                <div class="bg-[#09090b] border-t border-[#27272a] p-3 rounded-b-xl h-24 overflow-y-auto font-mono text-[9px] text-zinc-500 space-y-1" id="train-log"></div>
            </div>
            <button id="stop-train-btn" class="mt-4 px-4 py-2 bg-red-900/50 text-red-200 border border-red-800 rounded-lg text-xs hover:bg-red-900 transition-colors">Abort</button>
        </div>

        <!-- Import Modal -->
        <div id="import-overlay" class="absolute inset-0 z-50 flex items-center justify-center hidden flex-col">
            <div class="bg-[#18181b] border border-[#27272a] p-1 rounded-xl shadow-2xl w-[500px] max-w-[90%]">
                <div class="p-5">
                    <h3 class="text-sm font-bold text-white mb-4 flex items-center gap-2">
                        <i class="fa-solid fa-file-import text-blue-500"></i> Read & Chunk (Text Import)
                    </h3>
                    <div class="space-y-3">
                        <div>
                            <label class="block text-[9px] text-zinc-500 uppercase font-bold mb-1">Topic Name</label>
                            <input type="text" id="import-topic" class="w-full input-field rounded px-3 py-2 text-xs text-white" placeholder="e.g., The Moon">
                        </div>
                        <div>
                            <label class="block text-[9px] text-zinc-500 uppercase font-bold mb-1">Source Text</label>
                            <textarea id="import-source" class="w-full h-40 input-field rounded px-3 py-2 text-xs text-zinc-300 resize-none" placeholder="Paste a long article, essay, or wiki page here..."></textarea>
                        </div>
                    </div>
                </div>
                <div class="bg-[#09090b] border-t border-[#27272a] p-3 rounded-b-xl flex justify-end gap-2">
                    <button id="cancel-import" class="px-3 py-1.5 text-xs text-zinc-400 hover:text-white transition-colors">Cancel</button>
                    <button id="process-import" class="btn-primary px-3 py-1.5 rounded-md text-xs font-bold">Process & Add</button>
                </div>
            </div>
        </div>

    </main>

<script>
/**
 * MochaLLM Studio v5.3 - Toolbox Edition
 * Integrated 4 additional APIs for enhanced intelligence
 */

const CONFIG = {
    storageKey: 'mocha_llm_v5_data',
    systemKey: 'mocha_llm_v5_system'
};

const STATE = {
    isTraining: false,
    isModelReady: false,
    vectors: [],
    vocab: {},
    idf: {},
    synonyms: {  // Base synonyms
        "hi": "hello", "hey": "hello", "make": "cook", "prepare": "cook",
        "auto": "car", "ai": "bot", "who": "identity"
    }
};

// --- 1. Expanded ToolBelt ---
class ToolBelt {
    static async checkMath(input) {
        if (/^[\d\s+\-*/^().]+$/.test(input) || input.toLowerCase().startsWith("calculate")) {
            const expr = input.toLowerCase().replace("calculate", "").trim();
            try {
                const res = await fetch(`https://api.mathjs.org/v4/?expr=${encodeURIComponent(expr)}`);
                const answer = await res.text();
                return `The result is ${answer}.`;
            } catch (e) { return null; }
        }
        return null;
    }

    static async checkTime(input) {
        if (input.toLowerCase().includes("time in")) {
            const city = input.split("time in")[1].trim();
            if(city.includes("/")) {
                try {
                    const res = await fetch(`http://worldtimeapi.org/api/timezone/${city}`);
                    const data = await res.json();
                    if(data.datetime) return `Current time in ${city} is ${new Date(data.datetime).toLocaleTimeString()}.`;
                } catch(e) {}
            }
            return "Please use Area/City format (e.g., 'time in Europe/London').";
        }
        return null;
    }

    // New: Dictionary
    static async checkDefinition(input) {
        if (input.toLowerCase().startsWith("define ") || input.toLowerCase().includes("meaning of ")) {
            const word = input.split(" ").pop().replace(/[^a-zA-Z]/g, ""); 
            try {
                const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
                const data = await res.json();
                if (Array.isArray(data) && data[0].meanings[0]) {
                    const def = data[0].meanings[0].definitions[0].definition;
                    return `Definition of ${word}: ${def}`;
                }
            } catch (e) { return null; }
        }
        return null;
    }

    // New: Country Data
    static async checkCountry(input) {
        const capMatch = input.match(/capital of (.+)/i);
        const popMatch = input.match(/population of (.+)/i);
        
        if (capMatch || popMatch) {
            const country = (capMatch || popMatch)[1].replace("?", "").trim();
            try {
                const res = await fetch(`https://restcountries.com/v3.1/name/${country}`); 
                const data = await res.json();
                if (Array.isArray(data) && data[0]) {
                    const info = data[0];
                    if (capMatch) return `The capital of ${info.name.common} is ${info.capital ? info.capital[0] : "N/A"}.`;
                    if (popMatch) return `The population of ${info.name.common} is ${info.population.toLocaleString()}.`;
                }
            } catch (e) { return null; }
        }
        return null;
    }

    // New: Currency
    static async checkCurrency(input) {
        const match = input.match(/convert (\d+) (\w{3}) to (\w{3})/i);
        if (match) {
            const amount = parseFloat(match[1]);
            const from = match[2].toUpperCase();
            const to = match[3].toUpperCase();
            try {
                const res = await fetch(`https://open.er-api.com/v6/latest/${from}`);
                const data = await res.json();
                if (data.rates && data.rates[to]) {
                    return `${amount} ${from} is approximately ${(amount * data.rates[to]).toFixed(2)} ${to}.`;
                }
            } catch (e) { return null; }
        }
        return null;
    }

    // New: Jokes
    static async getJoke(input) {
        if (input.toLowerCase().includes("tell me a joke")) {
            try {
                const res = await fetch('https://v2.jokeapi.dev/joke/Programming,Pun?blacklistFlags=nsfw,religious,political,racist,sexist&type=single');
                const data = await res.json();
                if (data.joke) return data.joke;
            } catch (e) { return null; }
        }
        return null;
    }

    static async getWikipedia(query) {
        try {
            let q = query.replace(/^(who|what|where) (is|was|are|were)/i, "").replace(/^tell me about/i, "").replace(/[?]/g, "").trim();
            const url = `https://en.wikipedia.org/w/api.php?origin=*&action=query&format=json&prop=extracts&exintro&explaintext&redirects=1&titles=${encodeURIComponent(q)}`;
            const res = await fetch(url);
            const data = await res.json();
            const pageId = Object.keys(data.query.pages)[0];
            if (pageId === "-1") return null;
            let extract = data.query.pages[pageId].extract;
            return extract ? extract.split('. ').slice(0, 2).join('. ') + "." : null;
        } catch (e) { return null; }
    }

    static async getSynonyms(word) {
        try {
            const res = await fetch(`https://api.datamuse.com/words?ml=${word}&max=3`);
            const data = await res.json();
            return data.map(d => d.word);
        } catch (e) { return []; }
    }
}

// --- 2. Core Classes (Tokenizer, Vector, Generator) ---
class Tokenizer {
    static clean(text) { return text.toLowerCase().trim(); }
    static tokenize(text) {
        const raw = text.toLowerCase().match(/[\w']+|[+\-*/=<>?]|\d+/g) || [];
        return raw.map(t => STATE.synonyms[t] || t);
    }
}

class VectorEngine {
    constructor() { this.vocabSize = 0; }
    fit(documents) {
        const docCount = documents.length;
        const termDocCounts = {};
        documents.forEach(tokens => {
            new Set(tokens).forEach(t => {
                if (!STATE.vocab[t]) STATE.vocab[t] = this.vocabSize++;
                termDocCounts[t] = (termDocCounts[t] || 0) + 1;
            });
        });
        Object.keys(termDocCounts).forEach(term => STATE.idf[term] = Math.log(docCount / (1 + termDocCounts[term])));
    }
    vectorize(tokens) {
        const vec = {};
        let magnitude = 0;
        const tf = {};
        tokens.forEach(t => tf[t] = (tf[t] || 0) + 1);
        Object.keys(tf).forEach(term => {
            if (STATE.idf[term]) {
                const score = (tf[term] / tokens.length) * STATE.idf[term];
                vec[term] = score;
                magnitude += score * score;
            }
        });
        magnitude = Math.sqrt(magnitude);
        if (magnitude > 0) Object.keys(vec).forEach(t => vec[t] /= magnitude);
        return vec;
    }
    static cosineSimilarity(vecA, vecB) {
        let dot = 0;
        Object.keys(vecA).forEach(term => { if (vecB[term]) dot += vecA[term] * vecB[term]; });
        return dot;
    }
}

class Generator {
    constructor() { this.nGram = 3; this.model = new Map(); }
    train(dataPairs) {
        this.model.clear();
        dataPairs.forEach(pair => {
            const sequence = ["user", ":", ...pair.qTokens, "\n", "ai", ":", ...pair.aTokens];
            for(let i=0; i < sequence.length - 1; i++) {
                const ctx = sequence.slice(Math.max(0, i - this.nGram + 1), i+1).join(" ");
                const next = sequence[i+1];
                if(!this.model.has(ctx)) this.model.set(ctx, {});
                this.model.get(ctx)[next] = (this.model.get(ctx)[next] || 0) + 1;
            }
        });
    }
    predictNext(history, penalty = 1.2, topK = 5, temp = 1.0) {
        const ctx = history.slice(-this.nGram).join(" ");
        const dist = this.model.get(ctx);
        if (!dist) return null;
        const candidates = Object.keys(dist);
        const scores = {};
        let sum = 0;
        const recentTokens = new Set(history.slice(-10)); 
        candidates.forEach(token => {
            let count = dist[token];
            if (recentTokens.has(token)) count /= penalty;
            scores[token] = Math.pow(count, 1/temp);
        });
        const sorted = Object.keys(scores).sort((a,b) => scores[b] - scores[a]);
        const topCandidates = sorted.slice(0, topK);
        topCandidates.forEach(t => sum += scores[t]);
        let r = Math.random() * sum;
        for(const t of topCandidates) {
            r -= scores[t];
            if(r <= 0) return t;
        }
        return topCandidates[0];
    }
}

// --- DOM & Logic ---
const el = {
    trainBtn: document.getElementById('train-btn'),
    stopBtn: document.getElementById('stop-train-btn'),
    trainingData: document.getElementById('training-data'),
    sysPrompt: document.getElementById('system-prompt'),
    epochs: document.getElementById('param-epochs'),
    penalty: document.getElementById('param-penalty'),
    overlay: document.getElementById('training-overlay'),
    progressBar: document.getElementById('train-progress'),
    trainLog: document.getElementById('train-log'),
    chatArea: document.getElementById('chat-container'),
    chatForm: document.getElementById('chat-form'),
    userInput: document.getElementById('user-input'),
    vizBar: document.getElementById('viz-bar'),
    vizContainer: document.getElementById('token-viz-container'),
    confScore: document.getElementById('confidence-score'),
    tempSlider: document.getElementById('temperature'),
    tempVal: document.getElementById('temp-val'),
    copyBtn: document.getElementById('copy-btn'),
    resetBtn: document.getElementById('reset-btn'),
    stats: document.getElementById('dataset-stats'),
    saveStatus: document.getElementById('save-status'),
    welcome: document.getElementById('welcome-msg'),
    importBtn: document.getElementById('import-btn'),
    importOverlay: document.getElementById('import-overlay'),
    importTopic: document.getElementById('import-topic'),
    importSource: document.getElementById('import-source'),
    processImport: document.getElementById('process-import'),
    cancelImport: document.getElementById('cancel-import')
};

const engine = new VectorEngine();
const generator = new Generator();
let chart = null;

const defaultData = `User: Hello\nAI: Hi there! How can I help?\n\nUser: Who are you?\nAI: I am MochaLLM v5.3.\n\nUser: Good morning\nAI: Good morning! Have a great day.`;

function init() {
    el.trainingData.value = localStorage.getItem(CONFIG.storageKey) || defaultData;
    el.sysPrompt.value = localStorage.getItem(CONFIG.systemKey) || "You are a helpful assistant.";
    updateStats();
    initChart();
}

function updateStats() {
    const pairs = el.trainingData.value.split(/User:/i).length - 1;
    el.stats.innerText = `${pairs} Pairs`;
}

// --- Import Tool ---
el.importBtn.onclick = () => { el.importOverlay.classList.remove('hidden'); el.importOverlay.classList.add('flex'); el.importTopic.focus(); };
el.cancelImport.onclick = () => { el.importOverlay.classList.add('hidden'); el.importOverlay.classList.remove('flex'); };
el.processImport.onclick = () => {
    const topic = el.importTopic.value.trim();
    const source = el.importSource.value.trim();
    if(!topic || !source) return alert("Please fill both fields.");
    const sentences = source.match(/[^.!?]+[.!?]+/g) || [source];
    let newTrainingData = "";
    for (let i = 0; i < sentences.length; i += 2) {
        const chunk = sentences.slice(i, i + 2).join(" ").trim();
        if(chunk.length > 10) newTrainingData += `\n\nUser: Tell me about ${topic} (${Math.floor(i/2) + 1})\nAI: ${chunk}`;
    }
    el.trainingData.value += newTrainingData;
    updateStats();
    localStorage.setItem(CONFIG.storageKey, el.trainingData.value);
    el.importOverlay.classList.add('hidden'); el.importOverlay.classList.remove('flex');
    alert(`Imported ${Math.ceil(sentences.length/2)} chunks.`);
};

// --- Training ---
async function startTraining() {
    const text = el.trainingData.value;
    localStorage.setItem(CONFIG.storageKey, text);
    const blocks = text.split(/User:/i).filter(b => b.trim());
    const pairs = [];
    const allQTokens = [];
    blocks.forEach(b => {
        const [q, a] = b.split(/AI:/i);
        if(q && a) {
            const qTokens = Tokenizer.tokenize(q);
            const aTokens = Tokenizer.tokenize(a);
            pairs.push({ qTokens, aTokens, rawA: a.trim() });
            allQTokens.push(qTokens);
        }
    });
    if(pairs.length < 1) return alert("Need data!");
    STATE.isTraining = true;
    el.overlay.classList.remove('hidden'); el.overlay.classList.add('flex');
    log("Initializing...");
    engine.vocabSize = 0; STATE.vocab = {}; STATE.idf = {};
    engine.fit(allQTokens);
    STATE.vectors = pairs.map(p => ({ vec: engine.vectorize(p.qTokens), response: p.rawA, tokens: p.aTokens }));
    const epochs = parseInt(el.epochs.value);
    let currentEpoch = 0;
    async function loop() {
        if(!STATE.isTraining) return;
        currentEpoch++;
        const progress = currentEpoch / epochs;
        const loss = (1.5 * Math.exp(-progress * 4) + Math.random() * 0.1).toFixed(3);
        updateChart(currentEpoch, loss);
        el.progressBar.style.width = `${progress * 100}%`;
        document.getElementById('epoch-counter').innerText = `${Math.round(progress*100)}%`;
        if(currentEpoch < epochs) setTimeout(loop, 10);
        else {
            generator.train(pairs);
            STATE.isModelReady = true;
            el.overlay.classList.add('hidden'); el.overlay.classList.remove('flex');
            el.userInput.disabled = false; el.userInput.placeholder = "Ask something..."; el.userInput.focus();
            el.welcome.style.display = 'none';
            addBubble("System", "Training Complete. Tools Connected.", "sys");
        }
    }
    loop();
}

// --- Inference ---
async function generate(text) {
    el.vizContainer.innerHTML = ''; el.vizBar.style.height = 'auto';
    el.confScore.innerText = "Scanning Tools...";

    // Check specific tools first
    const joke = await ToolBelt.getJoke(text);
    if(joke) { addViz("TOOL", "JokeAPI", "tool"); return typeWriter(joke); }

    const def = await ToolBelt.checkDefinition(text);
    if(def) { addViz("TOOL", "Dictionary API", "tool"); return typeWriter(def); }

    const country = await ToolBelt.checkCountry(text);
    if(country) { addViz("TOOL", "Country Data", "tool"); return typeWriter(country); }

    const cur = await ToolBelt.checkCurrency(text);
    if(cur) { addViz("TOOL", "ExchangeRate API", "tool"); return typeWriter(cur); }

    const math = await ToolBelt.checkMath(text);
    if(math) { addViz("TOOL", "Math.js", "tool"); return typeWriter(math); }

    const time = await ToolBelt.checkTime(text);
    if(time) { addViz("TOOL", "WorldTime", "tool"); return typeWriter(time); }

    // Fallback to Vector Search + Wikipedia
    let inputTokens = Tokenizer.tokenize(text);
    let inputVec = engine.vectorize(inputTokens);
    let bestScore = -1, bestMatch = null;
    
    const unknownTokens = inputTokens.filter(t => !STATE.vocab.hasOwnProperty(t));
    const hasUnknown = unknownTokens.length > 0;
    if(hasUnknown) addViz("INFO", "Unknown Terms", "gen");

    STATE.vectors.forEach(mem => {
        const score = VectorEngine.cosineSimilarity(inputVec, mem.vec);
        if(score > bestScore) { bestScore = score; bestMatch = mem; }
    });

    el.confScore.innerText = `Confidence: ${(bestScore*100).toFixed(1)}%`;

    if (bestScore > 0.65 && !hasUnknown) {
        addViz("RAG", "Local Memory", "vec");
        typeWriter(bestMatch.response);
    } else {
        addViz("WARN", "Low Confidence", "fail");
        el.confScore.innerText = "Checking Wiki/Synonyms...";
        
        // Wiki
        const wiki = await ToolBelt.getWikipedia(text);
        if(wiki) { addViz("TOOL", "Wikipedia", "tool"); return typeWriter(wiki); }

        // Synonyms
        const mainWord = inputTokens.find(t => t.length > 3);
        if(mainWord) {
            const syns = await ToolBelt.getSynonyms(mainWord);
            if(syns.length > 0) {
                addViz("TOOL", `Synonyms: ${syns[0]}`, "tool");
                inputTokens = [...inputTokens, ...syns];
                inputVec = engine.vectorize(inputTokens);
                bestScore = -1;
                STATE.vectors.forEach(mem => {
                    const score = VectorEngine.cosineSimilarity(inputVec, mem.vec);
                    if(score > bestScore) { bestScore = score; bestMatch = mem; }
                });
                if(bestScore > 0.5) return typeWriter(bestMatch.response);
            }
        }

        if(bestScore > 0.3) {
            addViz("GEN", "N-Gram Guess", "gen");
            runGenerator(inputTokens);
        } else {
            typeWriter("I don't have enough data, and my external tools couldn't find an answer.");
        }
    }
}

async function runGenerator(tokens) {
    let hist = ["user", ":", ...tokens, "\n", "ai", ":"];
    let count = 0, txt = "";
    while(count < 50) {
        await new Promise(r => setTimeout(r, 30));
        const next = generator.predictNext(hist, parseFloat(el.penalty.value), 5, parseFloat(el.tempSlider.value));
        if(!next || next === "user" || next === "ai") break;
        txt += (count===0?"":" ") + next; hist.push(next); count++;
        document.querySelector('.bubble-ai:last-child .content').innerText = txt;
    }
}

async function typeWriter(text) {
    const bubble = document.querySelector('.bubble-ai:last-child .content');
    const words = text.split(" ");
    let cur = "";
    for(let w of words) { cur += w + " "; bubble.innerText = cur; await new Promise(r => setTimeout(r, 30)); }
}

// Helpers
function addBubble(name, text, type) {
    const div = document.createElement('div');
    if(type==='sys') { div.className="bubble bubble-system"; div.innerText=text; }
    else {
        div.className=`bubble ${type==='user'?'bubble-user':'bubble-ai'}`;
        div.innerHTML = type==='ai' ? `<div class="text-[9px] font-bold opacity-50 mb-1">${name}</div><div class="content">${text}</div>` : text;
    }
    el.chatArea.appendChild(div); el.chatArea.scrollTop = el.chatArea.scrollHeight;
}
function addViz(label, desc, type) {
    const s = document.createElement('span'); s.className = `badge ${type==='vec'?'badge-vec':type==='fail'?'badge-fail':type==='tool'?'badge-tool':'badge-gen'}`;
    s.innerHTML = `${label} <span class="font-normal opacity-70 ml-1">${desc}</span>`; el.vizContainer.appendChild(s);
}
function log(msg) { const d=document.createElement('div'); d.innerText=msg; el.trainLog.prepend(d); }
function initChart() {
    const ctx = document.getElementById('lossChart').getContext('2d');
    chart = new Chart(ctx, { type: 'line', data: { labels: [], datasets: [{ data: [], borderColor: '#3b82f6', borderWidth: 2, tension: 0.4, pointRadius: 0 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: false }, scales: { x: { display: false }, y: { display: false } }, animation: false } });
}
function updateChart(l, v) { chart.data.labels.push(l); chart.data.datasets[0].data.push(v); chart.update(); }

// Events
el.trainBtn.onclick = startTraining;
el.stopBtn.onclick = () => { STATE.isTraining = false; el.overlay.classList.add('hidden'); el.overlay.classList.remove('flex'); };
el.chatForm.onsubmit = (e) => { e.preventDefault(); const t = el.userInput.value.trim(); if(!t || !STATE.isModelReady) return; addBubble("User", t, "user"); addBubble("Mocha", "...", "ai"); el.userInput.value=''; generate(t); };
el.trainingData.oninput = () => { updateStats(); clearTimeout(window.saveTimer); window.saveTimer = setTimeout(() => { localStorage.setItem(CONFIG.storageKey, el.trainingData.value); }, 1000); };
el.copyBtn.onclick = () => navigator.clipboard.writeText(Array.from(document.querySelectorAll('.bubble')).map(b => b.innerText).join("\n\n")).then(() => alert("Copied!"));
el.resetBtn.onclick = () => { if(confirm("Reset?")) { localStorage.clear(); location.reload(); } };
el.tempSlider.oninput = (e) => document.getElementById('temp-val').innerText = e.target.value;

init();
</script>
</body>
</html>
